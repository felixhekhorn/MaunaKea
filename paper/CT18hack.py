"""Rescale CT18NNLO to CT18NNLO_NFX."""

import lhapdf
import matplotlib.pyplot as plt
import numpy as np
from eko import basis_rotation as br
from ekobox import genpdf

# PDF names
is_nf3 = True
if is_nf3:
    src = "CT18NNLO_NF3"
    target = "CT18NNLO_rescaled_NF3"
    QGRID = """1.295000E+00  1.427963E+00  1.580461E+00  1.756032E+00  1.958966E+00  2.194492E+00  2.469009E+00  2.790390E+00  3.168365E+00  3.615021E+00  4.145456E+00  4.778626E+00  5.538466E+00  6.455378E+00  7.568206E+00  8.926888E+00  1.059604E+01  1.265985E+01  1.522869E+01  1.844839E+01  2.251299E+01  2.768267E+01  3.430907E+01  4.287129E+01  5.402774E+01  6.869109E+01  8.813811E+01  1.141718E+02  1.493630E+02  1.974150E+02  2.637183E+02  3.562047E+02  4.866779E+02  6.729087E+02  9.419779E+02  1.335673E+03  1.919320E+03  2.796426E+03  4.133301E+03  6.201071E+03  9.448425E+03  1.462958E+04  2.303299E+04  3.689701E+04  6.017856E+04  1.000000E+05""".split()
else:
    src = "CT18NNLO_NF4"
    target = "CT18NNLO_rescaled_NF4"
    QGRID = """1.295000E+00  1.296247E+00  1.297497E+00  1.298747E+00  1.300000E+00  1.433559E+00  1.586746E+00  1.763113E+00  1.966971E+00  2.203575E+00  2.479353E+00  2.802216E+00  3.181938E+00  3.630665E+00  4.163562E+00  4.799675E+00  5.563048E+00  6.484222E+00  7.602215E+00  8.967190E+00  1.064405E+01  1.271734E+01  1.529792E+01  1.853223E+01  2.261512E+01  2.780783E+01  3.446339E+01  4.306278E+01  5.426687E+01  6.899168E+01  8.851849E+01  1.146563E+02  1.499845E+02  1.982176E+02  2.647618E+02  3.575703E+02  4.884763E+02  6.752914E+02  9.451517E+02  1.339920E+03  1.925022E+03  2.804090E+03  4.143590E+03  6.214805E+03  9.466527E+03  1.465285E+04  2.306151E+04  3.692863E+04  6.020532E+04  1.000000E+05""".split()
# load
central = lhapdf.mkPDF(src, 0)
errs = lhapdf.mkPDFs("CT18NNLO")
# CT18NNLO config
XGRID = """   9.261360E-010   1.131190E-009   1.381630E-009   1.687530E-009   2.061150E-009   2.517500E-009   3.074880E-009   3.755670E-009   4.587180E-009   5.602800E-009   6.843270E-009   8.358390E-009   1.020900E-008   1.246930E-008   1.523000E-008   1.860190E-008   2.272050E-008   2.775080E-008   3.389490E-008   4.139940E-008   5.056530E-008   6.176060E-008   7.543460E-008   9.213600E-008   1.125350E-007   1.374510E-007   1.678830E-007   2.050520E-007   2.504520E-007   3.059020E-007   3.736300E-007   4.563530E-007   5.573900E-007   6.807980E-007   8.315290E-007   1.015630E-006   1.240500E-006   1.515140E-006   1.850600E-006   2.260330E-006   2.760770E-006   3.372020E-006   4.118590E-006   5.030460E-006   6.144210E-006   7.504560E-006   9.166090E-006   1.119550E-005   1.367420E-005   1.670170E-005   2.039950E-005   2.491600E-005   3.043250E-005   3.717030E-005   4.539990E-005   5.545160E-005   6.772870E-005   8.272410E-005   1.010390E-004   1.234100E-004   1.507330E-004   1.841060E-004   2.248670E-004   2.746540E-004   3.354630E-004   4.097350E-004   5.004510E-004   6.112530E-004   7.465860E-004   9.118820E-004   1.113780E-003   1.360370E-003   1.661560E-003   2.029430E-003   2.478750E-003   3.027550E-003   3.697860E-003   4.516580E-003   5.516560E-003   6.737950E-003   8.229750E-003   1.005180E-002   1.227730E-002   1.499560E-002   1.831560E-002   2.237080E-002   2.732370E-002   3.337330E-002   4.076220E-002   4.978710E-002   6.081010E-002   7.427360E-002   9.071800E-002   1.108030E-001   1.353350E-001   1.446650E-001   1.546380E-001   1.652990E-001   1.766940E-001   1.888760E-001   2.018970E-001   2.158150E-001   2.306930E-001   2.465970E-001   2.635970E-001   2.817690E-001   3.011940E-001   3.219580E-001   3.441540E-001   3.678790E-001   3.932410E-001   4.203500E-001   4.493290E-001   4.803050E-001   5.134170E-001   5.488120E-001   5.611440E-001   5.737530E-001   5.866460E-001   5.998290E-001   6.133070E-001   6.270890E-001   6.411800E-001   6.555880E-001   6.703200E-001   6.853830E-001   7.007840E-001   7.165310E-001   7.326320E-001   7.490950E-001   7.659280E-001   7.831390E-001   8.007370E-001   8.187310E-001   8.248180E-001   8.309500E-001   8.371280E-001   8.433520E-001   8.496230E-001   8.559400E-001   8.623030E-001   8.687150E-001   8.751730E-001   8.816800E-001   8.882350E-001   8.948390E-001   9.014920E-001   9.081950E-001   9.149470E-001   9.217500E-001   9.286030E-001   9.355070E-001   9.424620E-001   9.494700E-001   9.565290E-001   9.636400E-001   9.708050E-001   9.780230E-001   9.852940E-001   9.926200E-001   1.000000E+000""".split()
# QGRID = """   1.295000E+000   1.298750E+000   1.464610E+000   1.659240E+000   1.890670E+000   2.167490E+000   2.500670E+000   2.904300E+000   3.396640E+000   4.001450E+000   4.750000E+000   5.767150E+000   7.070720E+000   8.758190E+000   1.096570E+001   1.388560E+001   1.779290E+001   2.308550E+001   3.034710E+001   4.044480E+001   5.468640E+001   7.507240E+001   1.047120E+002   1.485170E+002   2.143800E+002   3.152120E+002   4.725370E+002   7.229460E+002   1.129950E+003   1.806160E+003   2.955930E+003   4.958860E+003   8.538140E+003   1.510790E+004   2.751070E+004   5.162750E+004   1.000000E+005""".split()


def my_take_data(
    parent_pdf_set,
    members,
    xgrid,
    evolgrid,
):
    """Hack"""
    xgrid = [float(x) for x in XGRID]
    evolgrid = [(float(q) ** 2, 0) for q in QGRID]
    sorted_q2grid = [float(q2) for q2, _ in np.sort(evolgrid, axis=0)]
    # collect blocks
    all_blocks = []
    info = None
    heads = []
    info = genpdf.load.load_info_from_file("CT18NNLO")
    for mem in errs:
        all_blocks.append(
            [
                genpdf.generate_block(
                    lambda pid, x, Q2: mem.xfxQ2(pid, x, Q2)
                    / (errs[0].xfxQ2(pid, x, Q2) + 1e-20)  # avoid /0
                    * central.xfxQ2(pid, x, Q2),
                    xgrid,
                    sorted_q2grid,
                    br.flavor_basis_pids,
                )
            ]
        )
        heads.append("PdfType: error\n")
    heads[0] = "PdfType: central\n"

    return info, heads, all_blocks


# hack
genpdf.take_data = my_take_data
# do it!
genpdf.generate_pdf(target, br.flavor_basis_pids)


# plot
def plot():
    lhapdf.pathsPrepend(".")
    fakes = lhapdf.mkPDFs(target)
    pid = 21
    xgrid = np.linspace(1e-9, 1, 100)
    q2 = 10.0
    data_c = np.array([central.xfxQ2(pid, x, q2) for x in xgrid])
    data_err0 = np.array([errs[0].xfxQ2(pid, x, q2) for x in xgrid])
    data_err1 = np.array([errs[1].xfxQ2(pid, x, q2) for x in xgrid])
    data_fake0 = np.array([fakes[0].xfxQ2(pid, x, q2) for x in xgrid])
    data_fake1 = np.array([fakes[1].xfxQ2(pid, x, q2) for x in xgrid])
    fig, axs = plt.subplots(2, 1, sharex=True)
    axs[0].plot(xgrid, np.abs(data_c / data_fake0 - 1.0), label="src/fake-1")
    axs[0].set_yscale("log")
    axs[0].set_xscale("log")
    axs[0].legend()
    axs[1].plot(
        xgrid,
        np.abs((data_err1 / data_err0) / (data_fake1 / data_fake0) - 1.0),
        label="err/fake-1",
    )
    axs[1].set_yscale("log")
    axs[1].legend()
    fig.suptitle(f"{pid=},{q2=}")
    fig.tight_layout()
    fig.savefig("CT18hack.pdf")


plot()
