"""Patch CT18NNLO_NFX with the errors from CT18NNLO."""

import lhapdf
import numpy as np
from eko import basis_rotation as br
from ekobox import genpdf

# PDF names
# src = "CT18NNLO_NF3"
# target = "CT18NNLO_rescaled_NF3"
src = "CT18NNLO_NF4"
target = "CT18NNLO_rescaled_NF4"
# load
central = lhapdf.mkPDF(src, 0)
errs = lhapdf.mkPDFs("CT18NNLO")
parent_pdf_set = {1: lambda x, Q2: 1.0}
# CT18NNLO config
XGRID = """   9.261360E-010   1.131190E-009   1.381630E-009   1.687530E-009   2.061150E-009   2.517500E-009   3.074880E-009   3.755670E-009   4.587180E-009   5.602800E-009   6.843270E-009   8.358390E-009   1.020900E-008   1.246930E-008   1.523000E-008   1.860190E-008   2.272050E-008   2.775080E-008   3.389490E-008   4.139940E-008   5.056530E-008   6.176060E-008   7.543460E-008   9.213600E-008   1.125350E-007   1.374510E-007   1.678830E-007   2.050520E-007   2.504520E-007   3.059020E-007   3.736300E-007   4.563530E-007   5.573900E-007   6.807980E-007   8.315290E-007   1.015630E-006   1.240500E-006   1.515140E-006   1.850600E-006   2.260330E-006   2.760770E-006   3.372020E-006   4.118590E-006   5.030460E-006   6.144210E-006   7.504560E-006   9.166090E-006   1.119550E-005   1.367420E-005   1.670170E-005   2.039950E-005   2.491600E-005   3.043250E-005   3.717030E-005   4.539990E-005   5.545160E-005   6.772870E-005   8.272410E-005   1.010390E-004   1.234100E-004   1.507330E-004   1.841060E-004   2.248670E-004   2.746540E-004   3.354630E-004   4.097350E-004   5.004510E-004   6.112530E-004   7.465860E-004   9.118820E-004   1.113780E-003   1.360370E-003   1.661560E-003   2.029430E-003   2.478750E-003   3.027550E-003   3.697860E-003   4.516580E-003   5.516560E-003   6.737950E-003   8.229750E-003   1.005180E-002   1.227730E-002   1.499560E-002   1.831560E-002   2.237080E-002   2.732370E-002   3.337330E-002   4.076220E-002   4.978710E-002   6.081010E-002   7.427360E-002   9.071800E-002   1.108030E-001   1.353350E-001   1.446650E-001   1.546380E-001   1.652990E-001   1.766940E-001   1.888760E-001   2.018970E-001   2.158150E-001   2.306930E-001   2.465970E-001   2.635970E-001   2.817690E-001   3.011940E-001   3.219580E-001   3.441540E-001   3.678790E-001   3.932410E-001   4.203500E-001   4.493290E-001   4.803050E-001   5.134170E-001   5.488120E-001   5.611440E-001   5.737530E-001   5.866460E-001   5.998290E-001   6.133070E-001   6.270890E-001   6.411800E-001   6.555880E-001   6.703200E-001   6.853830E-001   7.007840E-001   7.165310E-001   7.326320E-001   7.490950E-001   7.659280E-001   7.831390E-001   8.007370E-001   8.187310E-001   8.248180E-001   8.309500E-001   8.371280E-001   8.433520E-001   8.496230E-001   8.559400E-001   8.623030E-001   8.687150E-001   8.751730E-001   8.816800E-001   8.882350E-001   8.948390E-001   9.014920E-001   9.081950E-001   9.149470E-001   9.217500E-001   9.286030E-001   9.355070E-001   9.424620E-001   9.494700E-001   9.565290E-001   9.636400E-001   9.708050E-001   9.780230E-001   9.852940E-001   9.926200E-001   1.000000E+000""".split()
QGRID = """   1.295000E+000   1.298750E+000   1.464610E+000   1.659240E+000   1.890670E+000   2.167490E+000   2.500670E+000   2.904300E+000   3.396640E+000   4.001450E+000   4.750000E+000   5.767150E+000   7.070720E+000   8.758190E+000   1.096570E+001   1.388560E+001   1.779290E+001   2.308550E+001   3.034710E+001   4.044480E+001   5.468640E+001   7.507240E+001   1.047120E+002   1.485170E+002   2.143800E+002   3.152120E+002   4.725370E+002   7.229460E+002   1.129950E+003   1.806160E+003   2.955930E+003   4.958860E+003   8.538140E+003   1.510790E+004   2.751070E+004   5.162750E+004   1.000000E+005""".split()


def my_take_data(
    parent_pdf_set,
    members,
    xgrid,
    evolgrid,
):
    """Hack"""
    xgrid = [float(x) for x in XGRID]
    evolgrid = [(float(q) ** 2, 0) for q in QGRID]
    sorted_q2grid = [float(q2) for q2, _ in np.sort(evolgrid, axis=0)]
    # collect blocks
    all_blocks = []
    info = None
    heads = []
    info = genpdf.load.load_info_from_file("CT18NNLO")
    for mem in errs:
        all_blocks.append(
            [
                genpdf.generate_block(
                    lambda pid, x, Q2: mem.xfxQ2(pid, x, Q2)
                    / (errs[0].xfxQ2(pid, x, Q2) + 1e-10)
                    * central.xfxQ2(pid, x, Q2),
                    xgrid,
                    sorted_q2grid,
                    br.flavor_basis_pids,
                )
            ]
        )
        heads.append("PdfType: error\nFormat: lhagrid1")
    heads[0] = "PdfType: central\nFormat: lhagrid1"

    return info, heads, all_blocks


# hack
genpdf.take_data = my_take_data
# do it!
genpdf.generate_pdf(target, br.flavor_basis_pids, parent_pdf_set=parent_pdf_set)
